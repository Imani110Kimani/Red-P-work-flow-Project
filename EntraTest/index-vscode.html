<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure AD Authentication - VS Code Compatible</title>
    <link rel="stylesheet" href="styles.css">
    <script src="msal-browser.min.js"></script>
    <script src="logger.js"></script>
    <style>
        .auth-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }
        
        .auth-method {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        
        .auth-method h3 {
            margin-top: 0;
            color: #b3d9ff;
        }
        
        .auth-method p {
            margin: 10px 0;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .login-url {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            margin: 10px 0;
        }
        
        .copy-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .copy-btn:hover {
            background: #218838;
        }
        
        .status-message {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }
        
        .success {
            background: rgba(40, 167, 69, 0.2);
            border-left: 4px solid #28a745;
        }
        
        .warning {
            background: rgba(255, 193, 7, 0.2);
            border-left: 4px solid #ffc107;
        }
        
        .error {
            background: rgba(220, 53, 69, 0.2);
            border-left: 4px solid #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Welcome Page -->
        <div id="welcomePage" class="page">
            <div class="welcome-card">
                <h1>Welcome to Our Application</h1>
                <p>Please sign in with your Microsoft account to continue.</p>
                
                <div id="statusMessage" class="status-message" style="display: none;">
                    <p id="statusText"></p>
                </div>
                
                <div class="auth-options">
                    <!-- Method 1: Try Popup (may be blocked) -->
                    <div class="auth-method">
                        <h3>ü™ü Method 1: Popup Login</h3>
                        <p>Quick login in a popup window (may be blocked in VS Code)</p>
                        <button id="popupLoginButton" class="login-btn">
                            Sign in with Popup
                        </button>
                    </div>
                    
                    <!-- Method 2: External Browser -->
                    <div class="auth-method">
                        <h3>üåê Method 2: External Browser (Recommended)</h3>
                        <p>Login using your regular browser - works around VS Code popup blocking:</p>
                        <div class="login-url" id="loginUrl">Generating login URL...</div>
                        <button id="copyUrlButton" class="copy-btn" onclick="copyLoginUrl()">Copy URL</button>
                        <button id="openExternalButton" class="login-btn" onclick="openInExternalBrowser()">Open in Browser</button>
                        <p style="font-size: 12px; margin-top: 10px; color: #b3d9ff;">
                            <strong>Steps:</strong><br>
                            1. Click "Open in Browser" or copy the URL<br>
                            2. Complete login in your regular browser<br>
                            3. After login, you'll be redirected back to this page<br>
                            4. The page will automatically process the login and take you to the dashboard
                        </p>
                    </div>
                    
                    <!-- Method 3: Manual Token -->
                    <div class="auth-method">
                        <h3>üîë Method 3: Skip to Dashboard</h3>
                        <p>For testing, go directly to dashboard (will use cached session if available)</p>
                        <button id="skipLoginButton" class="login-btn" onclick="skipToDemo()">Go to Dashboard</button>
                        <button class="btn" onclick="debugMSAL()" style="background: #6c757d; margin-top: 10px;">Debug MSAL</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logged In Page -->
        <div id="loggedInPage" class="page hidden">
            <div class="user-card">
                <h1>Welcome Back!</h1>
                <div class="user-info">
                    <p><strong>You are now logged in</strong></p>
                    <div id="userDetails">
                        <p>Name: <span id="userName">Loading...</span></p>
                        <p>Email: <span id="userEmail">Loading...</span></p>
                    </div>
                </div>
                <button id="logoutButton" class="logout-btn">Sign Out</button>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="loading hidden">
            <div class="spinner"></div>
            <p>Authenticating...</p>
        </div>
    </div>

    <script>
        // Azure AD Configuration
        const msalConfig = {
            auth: {
                clientId: "72a3b8b7-88dc-4325-a9a5-e8e7a915db27",
                authority: "https://login.microsoftonline.com/907b7f47-b8ae-4456-9e9c-b010d365753b",
                redirectUri: window.location.origin
            },
            cache: {
                cacheLocation: "sessionStorage",
                storeAuthStateInCookie: false
            }
        };

        const loginRequest = {
            scopes: ["User.Read"]
        };

        let myMSALObj;
        let welcomePage, loggedInPage, loadingSpinner, userName, userEmail;
        let popupLoginButton, statusMessage, statusText;

        // Initialize MSAL
        try {
            myMSALObj = new msal.PublicClientApplication(msalConfig);
            console.log('MSAL instance created successfully');
        } catch (error) {
            console.error('Failed to create MSAL instance', error);
        }

        // Generate login URL for external browser
        function generateLoginUrl() {
            const loginUrl = `https://login.microsoftonline.com/907b7f47-b8ae-4456-9e9c-b010d365753b/oauth2/v2.0/authorize?` +
                `client_id=72a3b8b7-88dc-4325-a9a5-e8e7a915db27` +
                `&response_type=code` +
                `&redirect_uri=${encodeURIComponent(window.location.origin)}` +
                `&response_mode=query` +
                `&scope=${encodeURIComponent('https://graph.microsoft.com/User.Read')}` +
                `&state=${Date.now()}`;
            
            document.getElementById('loginUrl').textContent = loginUrl;
            return loginUrl;
        }

        function copyLoginUrl() {
            const loginUrl = document.getElementById('loginUrl').textContent;
            navigator.clipboard.writeText(loginUrl).then(() => {
                showStatus('URL copied to clipboard!', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = loginUrl;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showStatus('URL copied to clipboard!', 'success');
            });
        }

        function openInExternalBrowser() {
            const loginUrl = document.getElementById('loginUrl').textContent;
            // Try to open in external browser
            const newWindow = window.open(loginUrl, '_blank');
            if (!newWindow) {
                showStatus('Popup blocked. Please copy the URL and open it manually in your browser.', 'warning');
            } else {
                showStatus('Login window opened. After logging in, copy the final URL and paste it below.', 'warning');
            }
        }

        function processResponseUrl() {
            const responseUrl = document.getElementById('responseUrl').value;
            if (!responseUrl) {
                showStatus('Please paste the response URL', 'error');
                return;
            }

            try {
                const url = new URL(responseUrl);
                const code = url.searchParams.get('code');
                
                if (code) {
                    showStatus('Authorization code found! Redirecting to dashboard...', 'success');
                    // For demo purposes, just go to dashboard
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 2000);
                } else {
                    showStatus('No authorization code found in URL. Please try again.', 'error');
                }
            } catch (error) {
                showStatus('Invalid URL format. Please check and try again.', 'error');
            }
        }

        function skipToDemo() {
            showStatus('Going to dashboard demo...', 'success');
            setTimeout(() => {
                window.location.href = 'dashboard.html';
            }, 1000);
        }

        function debugMSAL() {
            console.log('=== MSAL DEBUG INFO ===');
            console.log('Current URL:', window.location.href);
            console.log('MSAL Config:', msalConfig);
            
            const accounts = myMSALObj.getAllAccounts();
            console.log('All accounts:', accounts);
            
            const urlParams = new URLSearchParams(window.location.search);
            console.log('URL Parameters:');
            for (let [key, value] of urlParams) {
                console.log(`  ${key}: ${value}`);
            }
            
            // Try to manually handle redirect
            myMSALObj.handleRedirectPromise()
                .then(response => {
                    console.log('Manual handleRedirectPromise result:', response);
                    if (response) {
                        showStatus(`Manual redirect handling found: ${response.account?.name}`, 'success');
                    } else {
                        showStatus('Manual redirect handling: no response', 'warning');
                    }
                })
                .catch(error => {
                    console.error('Manual redirect handling error:', error);
                    showStatus(`Manual redirect handling error: ${error.message}`, 'error');
                });
        }

        function showStatus(message, type = 'info') {
            const statusMessage = document.getElementById('statusMessage');
            const statusText = document.getElementById('statusText');
            
            statusText.textContent = message;
            statusMessage.className = `status-message ${type}`;
            statusMessage.style.display = 'block';
            
            console.log(`Status (${type}):`, message);
        }

        // Initialize DOM elements
        function initializeDOMElements() {
            welcomePage = document.getElementById('welcomePage');
            loggedInPage = document.getElementById('loggedInPage');
            loadingSpinner = document.getElementById('loadingSpinner');
            userName = document.getElementById('userName');
            userEmail = document.getElementById('userEmail');
            popupLoginButton = document.getElementById('popupLoginButton');
            statusMessage = document.getElementById('statusMessage');
            statusText = document.getElementById('statusText');

            // Add popup login event listener
            if (popupLoginButton) {
                popupLoginButton.addEventListener('click', tryPopupLogin);
            }

            console.log('DOM elements initialized');
        }

        // Try popup login (may fail in VS Code)
        async function tryPopupLogin() {
            showStatus('Attempting popup login...', 'info');
            
            try {
                const loginResponse = await myMSALObj.loginPopup(loginRequest);
                console.log('Popup login successful:', loginResponse);
                
                if (loginResponse && loginResponse.account) {
                    showStatus(`Login successful! Welcome ${loginResponse.account.name}`, 'success');
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 2000);
                }
            } catch (error) {
                console.error('Popup login failed:', error);
                
                if (error.message.includes('popup')) {
                    showStatus('Popup blocked! Please try Method 2 (External Browser) below.', 'warning');
                } else {
                    showStatus(`Login failed: ${error.message}`, 'error');
                }
            }
        }

        // Show welcome page
        function showWelcomePage() {
            if (welcomePage) welcomePage.classList.remove('hidden');
            if (loggedInPage) loggedInPage.classList.add('hidden');
            if (loadingSpinner) loadingSpinner.classList.add('hidden');
        }

        // Initialize app
        async function initializeApp() {
            console.log('Initializing app...');
            
            try {
                // ALWAYS handle redirect promise first - this is crucial for MSAL
                console.log('Handling redirect promise...');
                const response = await myMSALObj.handleRedirectPromise();
                
                if (response) {
                    // This means we just completed a login flow
                    console.log('Login successful via redirect:', response.account.name);
                    showStatus(`Login successful! Welcome ${response.account.name}`, 'success');
                    
                    // Store the account info and redirect to dashboard
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 2000);
                    return;
                }
                
                // Check URL parameters for debugging
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                const error = urlParams.get('error');
                
                if (error) {
                    showStatus(`Authentication error: ${error}`, 'error');
                    return;
                }
                
                if (code) {
                    // We have a code but handleRedirectPromise didn't return a response
                    console.log('Found authorization code but no MSAL response');
                    showStatus('Found authorization code, but login processing failed. Trying dashboard anyway...', 'warning');
                    
                    // Try going to dashboard anyway - maybe the session was saved
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 3000);
                    return;
                }
                
                // No redirect response, check for existing accounts
                const accounts = myMSALObj.getAllAccounts();
                
                if (accounts.length > 0) {
                    console.log('Found existing account:', accounts[0].name);
                    showStatus('Already logged in! Redirecting...', 'success');
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 1500);
                } else {
                    console.log('No existing accounts, showing welcome page');
                    showWelcomePage();
                    generateLoginUrl();
                }
                
            } catch (error) {
                console.error('App initialization error:', error);
                showStatus(`Initialization error: ${error.message}`, 'error');
                showWelcomePage();
                generateLoginUrl();
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing...');
            console.log('Current URL:', window.location.href);
            console.log('URL search params:', window.location.search);
            
            initializeDOMElements();
            initializeApp();
        });

        console.log('VS Code compatible auth script loaded');
    </script>
</body>
</html>
