<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processing Login...</title>
    <link rel="stylesheet" href="styles.css">
    <script src="msal-browser.min.js"></script>
    <script src="logger.js"></script>
    <style>
        .processing-container {
            text-align: center;
            padding: 50px 20px;
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #ffffff;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-message {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
        }
        
        .success {
            background: rgba(40, 167, 69, 0.2);
            border-left: 4px solid #28a745;
        }
        
        .error {
            background: rgba(220, 53, 69, 0.2);
            border-left: 4px solid #dc3545;
        }
        
        .url-display {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="processing-container">
            <h1>Processing Your Login...</h1>
            
            <div class="spinner"></div>
            
            <div id="statusMessage" class="status-message">
                <p id="statusText">Checking authentication response...</p>
            </div>
            
            <div id="urlDisplay" class="url-display" style="display: none;">
                <p><strong>Current URL:</strong></p>
                <p id="currentUrl"></p>
            </div>
            
            <div id="debugInfo" style="display: none;">
                <h3>Debug Information:</h3>
                <div id="debugContent" style="font-family: monospace; font-size: 12px; text-align: left; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px;"></div>
            </div>
            
            <button id="manualButton" style="display: none;" class="login-btn" onclick="goToDashboard()">
                Continue to Dashboard
            </button>
        </div>
    </div>

    <script>
        // Azure AD Configuration (same as main app)
        const msalConfig = {
            auth: {
                clientId: "72a3b8b7-88dc-4325-a9a5-e8e7a915db27",
                authority: "https://login.microsoftonline.com/907b7f47-b8ae-4456-9e9c-b010d365753b",
                redirectUri: window.location.origin
            },
            cache: {
                cacheLocation: "sessionStorage",
                storeAuthStateInCookie: false
            }
        };

        const loginRequest = {
            scopes: ["User.Read"]
        };

        let myMSALObj;

        function updateStatus(message, type = 'info') {
            const statusElement = document.getElementById('statusText');
            const messageElement = document.getElementById('statusMessage');
            
            statusElement.textContent = message;
            messageElement.className = `status-message ${type}`;
            
            console.log(`Status (${type}):`, message);
            if (typeof logger !== 'undefined') {
                logger.info(`Redirect Handler: ${message}`);
            }
        }

        function showDebugInfo(info) {
            const debugDiv = document.getElementById('debugInfo');
            const debugContent = document.getElementById('debugContent');
            
            debugContent.textContent = JSON.stringify(info, null, 2);
            debugDiv.style.display = 'block';
        }

        function showCurrentUrl() {
            const urlDiv = document.getElementById('urlDisplay');
            const urlElement = document.getElementById('currentUrl');
            
            urlElement.textContent = window.location.href;
            urlDiv.style.display = 'block';
        }

        function goToDashboard() {
            updateStatus('Redirecting to dashboard...', 'success');
            setTimeout(() => {
                window.location.href = 'dashboard.html';
            }, 1000);
        }

        async function handleRedirectResponse() {
            try {
                updateStatus('Initializing MSAL...');
                
                // Create MSAL instance
                myMSALObj = new msal.PublicClientApplication(msalConfig);
                console.log('MSAL instance created');
                
                updateStatus('Processing authentication response...');
                showCurrentUrl();
                
                // Check URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                const error = urlParams.get('error');
                const state = urlParams.get('state');
                
                showDebugInfo({
                    hasCode: !!code,
                    hasError: !!error,
                    hasState: !!state,
                    fullUrl: window.location.href,
                    search: window.location.search
                });
                
                if (error) {
                    updateStatus(`Authentication error: ${error}`, 'error');
                    document.getElementById('manualButton').style.display = 'inline-block';
                    return;
                }
                
                if (code) {
                    updateStatus('Authorization code found! Processing...', 'success');
                    
                    // Handle the redirect response with MSAL
                    const response = await myMSALObj.handleRedirectPromise();
                    
                    if (response && response.account) {
                        updateStatus(`Login successful! Welcome ${response.account.name}`, 'success');
                        console.log('Redirect response processed:', response);
                        
                        setTimeout(() => {
                            window.location.href = 'dashboard.html';
                        }, 2000);
                    } else {
                        // Check if user is already authenticated
                        const accounts = myMSALObj.getAllAccounts();
                        if (accounts.length > 0) {
                            updateStatus(`Already authenticated! Welcome ${accounts[0].name}`, 'success');
                            setTimeout(() => {
                                window.location.href = 'dashboard.html';
                            }, 2000);
                        } else {
                            updateStatus('No account information received. Trying manual redirect...', 'error');
                            document.getElementById('manualButton').style.display = 'inline-block';
                        }
                    }
                } else {
                    // No code parameter - check if already authenticated
                    const accounts = myMSALObj.getAllAccounts();
                    if (accounts.length > 0) {
                        updateStatus('Already authenticated! Redirecting...', 'success');
                        setTimeout(() => {
                            window.location.href = 'dashboard.html';
                        }, 1500);
                    } else {
                        updateStatus('No authorization code found. Please try logging in again.', 'error');
                        setTimeout(() => {
                            window.location.href = 'index-vscode.html';
                        }, 3000);
                    }
                }
                
            } catch (error) {
                console.error('Error handling redirect:', error);
                updateStatus(`Error processing login: ${error.message}`, 'error');
                showDebugInfo({
                    error: error.message,
                    stack: error.stack
                });
                document.getElementById('manualButton').style.display = 'inline-block';
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Redirect handler page loaded');
            console.log('Current URL:', window.location.href);
            
            if (typeof logger !== 'undefined') {
                logger.info('Redirect handler initialized', {
                    url: window.location.href,
                    search: window.location.search
                });
            }
            
            handleRedirectResponse();
        });

        console.log('Redirect handler script loaded');
    </script>
</body>
</html>
